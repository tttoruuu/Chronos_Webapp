import streamlit as st
from PIL import Image
import base64
import random
from initializers import get_firestore_client
from datetime import date, datetime


# ランダムに表示する応援メッセージ
messages = [
"今日のあなた、ほんとに最高すぎ！完成された芸術作品みたいだよ～！",
"あなたが頑張ると、タスクが『え～、終わりたくない～！』って泣いちゃうかもね！",
"すごい！今日も地球の自転がちょっと速くなっちゃった気がする！",
"あなたがタスクこなす音って、なんかオーケストラみたいでかっこいい！",
"その仕上がり、きっと神様も『うわ～、やばい！』ってびっくりしてるよ！",
"あなたの頑張り、Googleで『奇跡』って調べたら出てきちゃうんじゃない？",
"今日の仕事ぶり、NASAの人が『スカウトしたい！』って来ちゃうかもね～！",
"あなたがいなかったら、このタスクたちきっと『迷子だよ～！』って泣いてたね。",
"おおっ、その完了タスクの山、なんだかピサの斜塔みたいにすごいね！",
"あなたの効率の良さって、もしかしてAIよりすごいんじゃない？",
"今日の成果、ミシュランから三ツ星もらえるレベルだよ～！",
"タスクが終わるたびに、私の心の中で花火が上がっちゃったよ！",
"あなたが頑張ると、近所の猫ちゃんたちが『にゃ～っ！』って拍手してる気がする～！",
"その達成感、まるで映画のエンドロールで流れる主人公みたいだね！",
"タスク倒しすぎて、あなたRPGのラスボスよりすごいんじゃない！？もう伝説だよ～！",
"タスクが終わるたびに、時計が『お疲れさま～！』って言ってるみたいだね！",
"あなたの努力で、なんだか宇宙がほんのちょっと広がった気がするよ～！",
"今日の仕事ぶり、ハリウッド映画のワンシーンに採用決定だね～！",
"あなたがやると、タスクが『終われてうれしい～！』ってニコニコしてるよ！",
"その集中力、瞬間接着剤もびっくりのすごさだね！",
"あなたの成果って、博物館に展示されてもいいレベルだよね～！",
"今日のあなた、タスク界の救世主（メシア）だよ！すごすぎ～！",
"あなたの仕事ぶり、カフェのラテアートみたいにきれいでかわいい！",
"タスクが終わるたび、地球が『やったね！』って震えてるみたいだよ～！",
"今日の努力、もう世界記録として申請しちゃう！？",
"あなたの頑張りのおかげで、空がいつもより青く見える気がする！",
"タスクをばっちり決める姿、なんだかアクション映画のヒーローみたい！",
"今日のあなた、もしかしてスーパーサイヤ人だったりする？",
"あなたがタスクを片付けるたびに、宇宙のバランスが整っちゃう感じ！",
"笑顔で、明日もまた一緒に伝説作っちゃおうね～！",
"なんて素晴らしいの！君の努力で地球がもっと輝いて見えるよ！",
"もう君は神話に出てくる伝説の英雄だね！全力で崇め奉りたい！",
"君のがんばりで、ゆきだまちゃんの心が1000倍の大きさになっちゃったよ！",
"おおお！君のすごさで、この世界が一瞬止まっちゃった！時をも止める努力！",
"すごい！すごすぎる！君の輝きでゆきだまちゃん、溶けそうだよ！",
"もうこれ、ノーベル賞級の努力だよ！授賞式を今すぐ準備しないと！",
"今日の君のがんばり、銀河系で一番だよ！全宇宙が拍手してる！",
"ゆきだまちゃんの辞書に“完璧”って言葉が追加された！君のおかげで！",
"もう君のすごさで、ゆきだまちゃんの目が星になっちゃったよ！キラッキラ！",
"君の努力、花が咲き、鳥が歌い、世界が祝福してるよ！",
"今日もすごく頑張ったね！君みたいに素敵な人を応援できて、ゆきだまちゃんは幸せだよ！",
"ねえ、気づいてる？君が頑張るたびに、ゆきだまちゃんの心がぽかぽかになるの…！",
"本当にえらい！明日も君の努力をそばで見られると思うと、楽しみで仕方ないよ！",
"今日の君、ちょっとかっこよすぎて、ゆきだまちゃんドキドキしちゃった！",
"君ががんばる姿、世界中の誰よりも輝いてるよ！もっともっと見ていたいな！",
"がんばりすぎないでね。でも、君が努力する姿は、どうしても応援したくなっちゃうんだ…！",
"今日の君、本当にすごかったよ！ゆきだまちゃん、君のこともっと知りたくなっちゃった！",
"君ががんばるたびに、ゆきだまちゃん、ちょっと自慢したくなるんだ！",
"君みたいに素敵な人と一緒にいられるなんて、ゆきだまちゃんって幸せ者だよね！",
"君の努力を見るとね…『明日も一緒にがんばりたい』って自然に思えちゃうんだ！",

]

def switch_page(page_name):
    st.session_state["current_page"] = page_name

def result_page():
    try:#Firestoreからデータを参照
        db = get_firestore_client()  # クライアントを関数内で取得
    except RuntimeError as e:
        st.error(f"Firestore クライアントの初期化エラー: {e}")
        return
    
    st.title('成果')
    st.text('')
    
    # 初期化: ページが読み込まれたときに1回だけ実行される
    if "progress" not in st.session_state:
        st.session_state.progress = 3  # 初期値を3%に設定

    # Firestore のデータからdone_countを取得
    uid = st.session_state["user"]["uid"]
    user_ref = db.collection("users").document(uid)
    user_data = user_ref.get().to_dict()
    done_co = user_data.get("done_count")

    if done_co is not None:
        done_co = done_co

    else:
        done_co = 0

    # アプリに何日目か表示
    st.title(f"{done_co}日完了だま！")

    # プログレスバーの値の計算
    score = done_co / 30 * 100
    if score >=100:
        score =100
    score_int = int(score)

    # プログレスバーの表示
    progress_text = ""
    my_bar = st.progress(score_int, text=progress_text)

    st.text('')

    #画像
    image = Image.open('ゆきだまちゃん.png')
    st.image(image, width=300)

    # ボタンを押したときにランダムメッセージを表示
    if st.button("ゆきだまちゃんに褒めてもらう"):
        random_message = random.choice(messages)  # ランダムに1つ選ぶ
        st.success(random_message)  # メッセージを表示
        st.balloons()  # 風船アニメーション

    if done_co >=30:
            if st.button("エンディングを見る"):
                st.title("～エンディング～")
                st.text("30日間、よく続いたね！本当にステキだま！")
                st.text("ここまで一緒にできて本当に嬉しい！そしてこれで私がいなくても1人でやっていけるね！")
                image = Image.open('エンディング02.png')
                st.image(image, width=800)
                st.text("")
                name = user_data.get("name")
                st.text(f"また私が必要ならいつでも戻ってきていいからね！")
                st.text(f"これからも頑張ってますます素敵な{name}になっていってね!")
                st.divider()
                st.text("   Developed by")
                st.text("     チーム・クロノス （Tech0 第9期 Step2-2 15班）")
                st.text("       ゆきち - Matsuoka Yuki")
                st.text("       ふくだま - Fukuda Mai")
                st.text("       とーるちゃん - Kobayashi Toru")
                st.text("       しょうさん - Sasaki Shohei")
                st.divider()
                st.text(f"クロノス神とゆきだまちゃんたちに見守られながら、{name}の挑戦はまだまだ続く・・・")

    #st.button("戻る", on_click=lambda: switch_page("トレーニング"))
